<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="author" content="Summer High School Institute Course on Cell Phone App Development">
    <meta name="description" content="Plant and flower application">
    <meta name="keywords" content="Plant, Flower, Environment">

    <link rel="icon" type="image/x-icon" href="fav.ico">
      
    <title>Plant Watering App</title>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: #a1c9a1;
            font-size: 16px;
            color: #333;
            touch-action: none;
        }

        header {
            background-image: url('header.avif');
            background-size: cover;
            background-position: center;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        header h1 {
            color: white;
            font-size: 1.8rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
        }

        .tabbar {
            display: flex;
            justify-content: space-around;
            background-color: #4caf50;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .tablink {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            color: white;
            background-color: #4caf50;
            border: none;
            cursor: pointer;
            text-align: center;
        }

        .tablink:hover {
            background-color: #66bb6a;
        }

        .tabcontent {
            display: none;
            padding: 20px;
        }

        .tabcontent h1 {
            color: #2e7d32;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        p {
            font-size: 1rem;
            margin-bottom: 15px;
        }

        img {
            width: 100%;
            max-width: 320px;
            margin: 10px auto;
            display: block;
            border-radius: 12px;
            border: 1px solid #ccc;
        }

        video {
            width: 100%;
            height: 100vh;
            margin: 0px auto;
            display: block;
            border-radius: 12px;
            border: 1px solid #ccc;
            object-fit: fill;
            position: absolute;
        }
        
        button {
            width: 100%;
            max-width: 320px;
            margin: 10px auto;
            display: block;
            padding: 12px;
            font-size: 16px;
            background-color: #81c784;
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
        }

        button:hover {
            background-color: #66bb6a;
        }

        button:disabled,
        button[disabled]{
          border: 1px solid #999999;
          background-color: #cccccc;
          color: #666666;
        }

        #errorMessageId,
        #warningMessageId {
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            padding: 10px;
            display: none;
            text-align: center;
        }

        #errorMessageId {
            background-color: #e53935;
            color: white;
        }

        #warningMessageId {
            background-color: #fbc02d;
            color: black;
        }

        a {
            color: #2e7d32;
            text-decoration: underline;
        }

        #photosContainer img {
            width: 100px;
            margin: 5px;
            border-radius: 8px;
        }

        .container
        {
            height: 240px;
            position: relative;
        }
        .container video
        {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 240px;
            z-index: 1 !important;
        }
        .container .overlay
        {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 20px;
            z-index: 2;
        }
        .container .overlay h3
        {
            font-size: 1em;
            color: #fff;
            font-weight: bold;
        }

        /* The Modal (background) */
        .modal {
          display: none; /* Hidden by default */
          position: fixed; /* Stay in place */
          z-index: 999; /* Sit on top */
          padding-top: 100px; /* Location of the box */
          left: 0;
          top: 0;
          width: 100%; /* Full width */
          height: 100%; /* Full height */
          overflow: auto; /* Enable scroll if needed */
          background-color: rgb(0,0,0); /* Fallback color */
          background-color: rgba(0,0,0,0.9); /* Black w/ opacity */
        }
        
        /* Modal Content (image) */
        .modal-content {
          margin: auto;
          display: block;
          width: 80%;
          max-width: 700px;
        }

        /* Caption of Modal Image */
        #caption {
          margin: auto;
          display: block;
          width: 80%;
          max-width: 700px;
          text-align: center;
          color: #ccc;
          padding: 10px 0;
          height: 150px;
        }
        
        /* Add Animation */
        .modal-content, #caption {  
          -webkit-animation-name: zoom;
          -webkit-animation-duration: 0.6s;
          animation-name: zoom;
          animation-duration: 0.6s;
        }

        @-webkit-keyframes zoom {
          from {-webkit-transform:scale(0)} 
          to {-webkit-transform:scale(1)}
        }
        
        @keyframes zoom {
          from {transform:scale(0)} 
          to {transform:scale(1)}
        }
        
        /* The Close Button */
        .close {
          position: absolute;
          top: 15px;
          right: 35px;
          color: #f1f1f1;
          font-size: 40px;
          font-weight: bold;
          transition: 0.3s;
        }
        
        .close:hover,
        .close:focus {
          color: #bbb;
          text-decoration: none;
          cursor: pointer;
        }
        
        /* Extra small devices (phones, 600px and down) */
        @media only screen and (max-width: 600px) {
          * {
                font-size: 10pt;
                overflow-y: scroll;
              /*  
                white-space: nowrap;
                overflow-y: scroll;
                text-overflow: ellipsis; 
              */
          }
        }
    </style>
</head>

<body>

    <section id="errorMessageId"></section>
    <section id="warningMessageId"></section>
    
    <header>
        <h1>Plant Watering App</h1>
    </header>

    <nav class="tabbar">
        <button id="HomeContentId" class="tablink" data-tab="HomeContent">Home</button>
        <button id="CameraContentId" class="tablink" data-tab="CameraContent">Camera</button>
        <button id="GalleryContentId" class="tablink" data-tab="GalleryContent">Gallery</button>
        <button id="DetailsContentId" class="tablink" data-tab="DetailsContent">Details</button>
    </nav>

    <div id="HomeContent" class="tabcontent">
        <h2>Welcome to the Plant Watering App</h2>
        <p>This app helps support plant care and reduce water waste.</p>
        <p>Developed in Summer 2025 as part of a two-week mobile app workshop.</p>
        <img src="qrcode_se4cps.github.io.png" style="width: 50%" />
        <p>Want to contribute? Visit our open-source project on GitHub:</p>
        <p><a href="https://github.com/SE4CPS/PlantWateringCellPhoneApp/" target="_blank">GitHub Repository</a>
        </p>
    </div>

    <div id="CameraContent" class="tabcontent">
        <div class="container">
                <video id="video" autoplay playsinline controls></video>
                Your browser does not support the video tag.
            </video>
            <div class="overlay">
                ðŸŽ¥ ðŸŒ´ðŸŒ¼
            </div>
        </div>
        
        <canvas id="canvas" style="display:none;"></canvas>
        <img id="photo" alt="">
        <button id="captureButton">Take Photo ðŸŽ¥</button>
        <button id="saveButton">Save Photo ðŸ’¾</button>
        <button id="deleteButton">Delete Photo ðŸ—‘</button>
    </div>

    <div id="GalleryContent" class="tabcontent">
        <div id="photosContainer"></div>
        <button id="analyzeButton">Analyze Photo (TBD)</button>
    </div>

    <div id="DetailsContent" class="tabcontent">

    </div>

    <!-- The Modal -->
    <div id="myModal" class="modal">
      <span class="close">&times;</span>
      <img class="modal-content" id="img01">
      <div id="caption"></div>
    </div>

    <script>
      
        function openTab(tabId, element) {
            document.querySelectorAll('.tabcontent').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.tablink').forEach(t => t.style.backgroundColor = '#4caf50');
            document.getElementById(tabId).style.display = 'block';
            element.style.backgroundColor = '#66bb6a';
        }

        function buttonOnHold(button) {
            button.setAttribute("disabled",true);
            setTimeout(function(){
              button.removeAttribute("disabled");
            },4000);             
        }
        
        document.addEventListener('DOMContentLoaded', () => {          
            document.querySelectorAll('.tablink').forEach(button => {
                button.addEventListener('click', () => {
                    openTab(button.getAttribute('data-tab'), button);
                });
            });
            document.querySelector('.tablink').click(); // Open default tab
        });

        const modal = document.getElementById("myModal");
        
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photo = document.getElementById('photo');
        const captureButton = document.getElementById('captureButton');
        const saveButton = document.getElementById('saveButton');
        const deleteButton = document.getElementById('deleteButton');
        const analyzeButton = document.getElementById('analyzeButton');
        const now = new Date().toLocaleString();

        // Get the <span> element that closes the modal
        const span = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() { 
            modal.style.display = "none";
        }

        const db = indexedDB.open("PlantPhotos", 1);
        db.onupgradeneeded = function (event) {
            const db = event.target.result;
            if (!db.objectStoreNames.contains("photos")) {
                db.createObjectStore("photos", { keyPath: "id", autoIncrement: true });
            }
        };
        db.onsuccess = function () {
            console.log("Database opened successfully");
        };
        db.onerror = function (event) {
            console.error("Database error:", event.target.errorCode);
        };

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
            } catch (err) {
                const errorMessage = document.getElementById('errorMessageId');
                errorMessage.style.display = 'block';
                errorMessage.innerHTML = `<p>Error accessing the camera: ${err.message}</p>`;
                setTimeout(() => errorMessage.style.display = 'none', 5000);
            }
        }

        captureButton.addEventListener('click', () => {
            buttonOnHold(captureButton);
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            photo.src = canvas.toDataURL('image/jpeg');         
        });

        deleteButton.addEventListener('click', () => {
            photo.src = '';
            buttonOnHold(deleteButton);
        });

        document.getElementById('GalleryContentId').addEventListener('click', () => {
            loadPhotos();
            let audio = new Audio('music.mp3');
            audio.play();
        });

        saveButton.addEventListener('click', () => {
            buttonOnHold(saveButton);
            const imageDataUrl = canvas.toDataURL('image/jpeg');
            const link = document.createElement('a');
            // link.href = imageDataUrl;
            // link.download = now + '.jpg';
            document.body.appendChild(link);
            // link.click();

            const transaction = db.result.transaction("photos", "readwrite");
            const store = transaction.objectStore("photos");
            const data = { timestamp: now, image: imageDataUrl };

            const request = store.add(data);
            request.onsuccess = () => {
                console.log("Saved to IndexedDB", data);
                loadPhotos();
            };
            request.onerror = event => {
                console.error("IndexedDB save error:", event.target.errorCode);
            };
        });

        function loadPhotos() {
            const transaction = db.result.transaction("photos", "readonly");
            const store = transaction.objectStore("photos");
            const request = store.getAll();
            const container = document.getElementById('photosContainer');

            request.onsuccess = event => {
                const photos = event.target.result;
                container.innerHTML = '';
                photos.forEach(photoData => {

                    const photoId = photoData.id;

                    const img = document.createElement('img');
                    const div = document.createElement('div');

                    div.style.display = 'flex';
                    div.style.gap = '5px';
                    div.style.marginBottom = '5px';
                    div.style.borderBottom = '1px solid gray';

                    const deleteButton = document.createElement('button');
                    const detailsButton = document.createElement('button');

                    deleteButton.style.backgroundColor = '#e56c6c';

                    deleteButton.innerHTML = 'Delete &#9940;';
                    detailsButton.innerHTML = 'Details &#128269;';

                    detailsButton.addEventListener('click', function() {
                        console.log("TBD: Scale image on button click...");
                        modal.style.display = "block";
                        var img = document.getElementById("photoId"+photoId);
                        var modalImg = document.getElementById("img01");
                        modalImg.src = img.src;
                        captionText.innerHTML = this.alt;
                        // img.style.transform = 'scale(3,3)';                 
                    });

                    img.src = photoData.image;
                    img.alt = photoData.timestamp;
                    img.id = "photoId"+photoId;

                    div.appendChild(img);
                    div.appendChild(detailsButton);
                    div.appendChild(deleteButton);

                    deleteButton.addEventListener('click', () => {
                        buttonOnHold(captureButton);
                        if (confirm("Are you sure you want to delete this photo?")) {

                            // Delete from database
                            deleteItem(photoId);

                        } else {
                            console.log("Photo deletion canceled.");
                        }

                    });

                    container.appendChild(div);
                });
            };
            request.onerror = event => {
                console.error("Load error:", event.target.errorCode);
            };
        }

        function deleteItem(id) {
            let request = indexedDB.open("PlantPhotos", 1);

            request.onsuccess = function (event) {
                let db = event.target.result;

                let transaction = db.transaction(["photos"], "readwrite");
                let objectStore = transaction.objectStore("photos");
                let deleteRequest = objectStore.delete(id);

                deleteRequest.onsuccess = function () {
                    console.log("Deleted", id);
                };

                transaction.oncomplete = function () {
                    loadPhotos();
                };

                transaction.onerror = function (event) {
                    console.error("Transaction error:", event.target.error);
                };
            };

            request.onerror = function (event) {
                console.error("Database open error:", event.target.error);
            };
        }


        function checkBatteryStatus() {
            navigator.getBattery().then(battery => {
                const warningMessage = document.getElementById('warningMessageId');
                if (battery.level < 0.1) {
                    warningMessage.style.display = 'block';
                    warningMessage.innerHTML = `<p>Low Battery: Please charge your device</p>`;
                } else {
                    warningMessage.style.display = 'none';
                }
            }).catch(err => {
                console.error("Battery check failed:", err);
            });
        }

        async function getData() {

            return;
            
            const url = "https://perenual.com/api/v2/species-list?key=sk-O4Vg68431f0dc1a5010877";
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                console.log(data);
            } catch (error) {
                console.error("getData error:", error.message);
            }
        }

        async function analyzeFlower() {
            console.log("disabled function");
        }

        analyzeButton.addEventListener('click', function() {
            buttonOnHold(analyzeButton);
            analyzeFlower();
        });

        window.addEventListener('load', () => {
            startCamera();
            checkBatteryStatus();
            getData();
        });

    </script>
</body>

</html>
